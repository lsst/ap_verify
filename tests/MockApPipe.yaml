description: Mock Alert Production pipeline. Use only for testing!

parameters:
  # only templates in ap_verify_testdata
  coaddName: goodSeeing
  # only refcat in ap_verify_testdata
  refcat: gaia
tasks:
  isr:
    class: lsst.ap.verify.testPipeline.MockIsrTask
    config:
      # ap_verify_testdata lacks many auxiliary inputs
      doDark: False
      doDefect: False
  characterizeImage: lsst.ap.verify.testPipeline.MockCharacterizeImageTask
  calibrate:
    class: lsst.ap.verify.testPipeline.MockCalibrateTask
    config:
      connections.astromRefCat: parameters.refcat
      connections.photoRefCat: parameters.refcat
      # Backwards-compatibility with Gen 2
      astromRefObjLoader.ref_dataset_name: parameters.refcat
      photoRefObjLoader.ref_dataset_name: parameters.refcat
      # ap_verify_testdata has bad refcats
      doAstrometry: False
      doPhotoCal: False
  imageDifference:
    class: lsst.ap.verify.testPipeline.MockImageDifferenceTask
    config:
      doWriteWarpedExp: True             # Required for packaging alerts in diaPipe
      doSkySources: True
      coaddName: parameters.coaddName              # Can be removed once ImageDifference no longer supports Gen 2
      connections.coaddName: parameters.coaddName
  transformDiaSrcCat:
    class: lsst.ap.verify.testPipeline.MockTransformDiaSourceCatalogTask
    config:
      doRemoveSkySources: True
      connections.coaddName: parameters.coaddName
  diaPipe:
    class: lsst.ap.verify.testPipeline.MockDiaPipelineTask
    config:
      doWriteAssociatedSources: True
      connections.coaddName: parameters.coaddName
contracts:
  # DiaPipelineTask needs diaSource fluxes, catalogs, warped exposures, and difference exposures
  - imageDifference.doMeasurement is True
  - imageDifference.doWriteSources is True
  - imageDifference.doWriteWarpedExp is True
  - imageDifference.doWriteSubtractedExp is True
  - imageDifference.doSkySources == transformDiaSrcCat.doRemoveSkySources
  # Inputs and outputs must match
  # Use of ConnectionsClass for templated fields is a workaround for DM-30210
  - retrieveTemplate.connections.ConnectionsClass(config=retrieveTemplate).outputExposure.name ==
      imageDifference.connections.ConnectionsClass(config=imageDifference).inputTemplate.name
  - imageDifference.connections.ConnectionsClass(config=imageDifference).subtractedExposure.name ==
      transformDiaSrcCat.connections.ConnectionsClass(config=transformDiaSrcCat).diffIm.name
  - imageDifference.connections.ConnectionsClass(config=imageDifference).diaSources.name ==
      transformDiaSrcCat.connections.ConnectionsClass(config=transformDiaSrcCat).diaSourceCat.name
  - imageDifference.connections.ConnectionsClass(config=imageDifference).subtractedExposure.name ==
        diaPipe.connections.ConnectionsClass(config=diaPipe).diffIm.name
  - imageDifference.connections.ConnectionsClass(config=imageDifference).warpedExposure.name ==
        diaPipe.connections.ConnectionsClass(config=diaPipe).warpedExposure.name
  - imageDifference.connections.ConnectionsClass(config=imageDifference).exposure.name ==
      diaPipe.connections.ConnectionsClass(config=diaPipe).exposure.name
  - transformDiaSrcCat.connections.ConnectionsClass(config=transformDiaSrcCat).diaSourceTable.name ==
        diaPipe.connections.ConnectionsClass(config=diaPipe).diaSourceTable.name
