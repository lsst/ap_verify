# Gen 3 pipeline for ap_verify
# This concatenates various lsst.verify metrics to an AP pipeline

description: Fully instrumented AP pipeline
imports:
    - location: $AP_PIPE_DIR/pipelines/ApPipe.yaml
    - location: $AP_VERIFY_DIR/pipelines/MetricsRuntime.yaml
    - location: $AP_VERIFY_DIR/pipelines/MetricsMisc.yaml
tasks:
    imageDifference:
        class: lsst.pipe.tasks.imageDifference.ImageDifferenceTask
        config:
            # All extant datasets use deep templates
            # TODO: move to dataset configs in DM-26140
            coaddName: deep              # Can be removed once ImageDifference no longer supports Gen 2
            getTemplate.coaddName: deep  # Can be removed once ImageDifference no longer supports Gen 2
            connections.coaddName: deep
            # TODO: redundant connection definitions workaround for DM-30210
            connections.coaddExposures: deepCoadd
            connections.subtractedExposure: deepDiff_differenceExp
            connections.warpedExposure: deepDiff_warpedExp
            # TODO: end DM-30210 workaround
    transformDiaSrcCat:
        class: lsst.ap.association.TransformDiaSourceCatalogTask
        config:
            # TODO: move to dataset configs in DM-26140
            connections.coaddName: deep
            # TODO: redundant connection definitions workaround for DM-30210
            connections.diaSourceSchema: deepDiff_diaSrc_schema
            connections.diaSourceCat: deepDiff_diaSrc
            connections.diffIm: deepDiff_differenceExp
            connections.diaSourceTable: deepDiff_diaSrcTable
            # TODO: end DM-30210 workaround
    diaPipe:
        # TODO: how to prevent duplication with ApPipe definition?
        class: lsst.ap.association.DiaPipelineTask
        config:
            apdb.isolation_level: READ_UNCOMMITTED
            doPackageAlerts: True
            # TODO: move to dataset configs in DM-26140
            connections.coaddName: deep
            # TODO: redundant connection definitions workaround for DM-30210
            connections.diaSourceTable: deepDiff_diaSrcTable
            connections.associatedDiaSources: deepDiff_assocDiaSrcTable
            # TODO: end DM-30210 workaround
contracts:
    # Metric inputs must match pipeline outputs
    - imageDifference.connections.coaddName == fracDiaSourcesToSciSources.connections.coaddName
    - imageDifference.connections.fakesType == fracDiaSourcesToSciSources.connections.fakesType
