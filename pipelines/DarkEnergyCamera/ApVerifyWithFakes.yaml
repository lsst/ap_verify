# Gen 3 pipeline for ap_verify
# This concatenates various lsst.verify metrics to an AP pipeline

# This pipeline assumes $AP_PIPE_DIR/pipelines/DarkEnergyCamera/RunIsrForCrosstalkSources.yaml
# has already been run.

instrument: lsst.obs.decam.DarkEnergyCamera
description: Fully instrumented AP pipeline with fakes, specialized for DECam
imports:
  - location: $AP_VERIFY_DIR/pipelines/_ingredients/ApVerifyWithFakes.yaml
    exclude:
      - processCcd
  - location: $AP_PIPE_DIR/pipelines/DarkEnergyCamera/ProcessCcd.yaml
  # Can't use $AP_PIPE_DIR/pipelines/DarkEnergyCamera/ApPipeWithFakes.yaml here
  # because the changes made by that file and ../ApVerifyWithFakes.yaml are
  # hard to separate.
tasks:
  processVisitFakes:
    class: lsst.pipe.tasks.processCcdWithFakes.ProcessCcdWithVariableFakesTask
    config:
      # Mirror calibrate config from DarkEnergyCamera/ProcessCcd.yaml
      calibrate.photoCal.match.referenceSelection.magLimit.fluxField: i_flux
      calibrate.photoCal.match.referenceSelection.magLimit.maximum: 22.0
  transformDiaSrcCatWithFakes:
    class: lsst.ap.association.TransformDiaSourceCatalogTask
    config:
      doIncludeReliability: True
  rbClassify:
    class: lsst.meas.transiNet.RBTransiNetTask
    config:
      modelPackageName: 'rbResnet50-DC2'
      connections.coaddName: parameters.coaddName
      connections.fakesType: parameters.fakesType
