# Gen 3 pipeline for ap_verify
# This concatenates various lsst.verify metrics to an AP pipeline

description: Fully instrumented AP pipeline with fakes
imports:
  - location: $AP_PIPE_DIR/pipelines/ApPipeWithFakes.yaml
  - location: $AP_VERIFY_DIR/pipelines/MetricsRuntime.yaml
  - location: $AP_VERIFY_DIR/pipelines/MetricsMisc.yaml
  - location: $AP_VERIFY_DIR/pipelines/MetricsForFakes.yaml
parameters:
  fakesType: fakes_
tasks:
  createFakes:
    class: lsst.ap.pipe.createApFakes.CreateRandomApFakesTask
    config:
      magMin: 20
      magMax: 26
      fakeDensity: 2000
      connections.fakesType: parameters.fakesType
  coaddFakes:
    class: lsst.pipe.tasks.insertFakes.InsertFakesTask
    config:
      doSubSelectSources: True
      select_col: "isTemplateSource"
      connections.coaddName: parameters.coaddName
      connections.fakesType: parameters.fakesType
  processVisitFakes:
    class: lsst.pipe.tasks.processCcdWithFakes.ProcessCcdWithVariableFakesTask
    config:
      connections.fakesType: parameters.fakesType
      insertFakes.doSubSelectSources: True
      insertFakes.select_col: "isVisitSource"
  retrieveTemplate:
    class: lsst.ip.diffim.getTemplate.GetTemplateTask
    config:
        connections.coaddName: parameters.coaddName
  retrieveTemplateWithFakes:
    class: lsst.ip.diffim.getTemplate.GetTemplateTask
    config:
      connections.coaddName: parameters.coaddName
      connections.fakesType: parameters.fakesType

  # Contracts require imageDifference, transformDiaSrc, and diaPipe to have matching configs.
  # Since diaPipe must include fakes (see below), do non-fakes processing with non-standard names.
  imageDifferenceNoFakes:
    class: lsst.pipe.tasks.imageDifference.ImageDifferenceFromTemplateTask
    config:
      doWriteWarpedExp: True       # Required for packaging alerts in diaPipe
      doSkySources: True
      coaddName: parameters.coaddName
      connections.coaddName: parameters.coaddName
  imageDifferenceWithFakes:
    class: lsst.pipe.tasks.imageDifference.ImageDifferenceFromTemplateTask
    config:
      doWriteWarpedExp: True       # Required for packaging alerts in diaPipe
      connections.fakesType: parameters.fakesType
  transformDiaSrcCatWithFakes:
    class: lsst.ap.association.TransformDiaSourceCatalogTask
    config:
      connections.fakesType: parameters.fakesType
  # Can't have separate with- and without-fakes runs for diaPipe, because there's only one APDB
  diaPipe:
    class: lsst.ap.association.DiaPipelineTask
    config:
      doPackageAlerts: True
      doWriteAssociatedSources: True
      connections.fakesType: parameters.fakesType
  fakesMatch:
    class: lsst.pipe.tasks.matchFakes.MatchVariableFakesTask
    config:
      matchDistanceArcseconds: 0.1
      connections.coaddName: parameters.coaddName
      connections.fakesType: parameters.fakesType
  fracDiaSourcesToSciSources:
    # Uses output of imageDifferenceNoFakes
    class: lsst.ip.diffim.metrics.FractionDiaSourcesToSciSourcesMetricTask
    config:
      connections.coaddName: parameters.coaddName
  timing_imageDifference:
    class: lsst.verify.tasks.commonMetrics.TimingMetricTask
    config:
      connections.labelName: imageDifferenceNoFakes
      target: imageDifferenceNoFakes.run
  timing_imageDifference_astrometer:
    class: lsst.verify.tasks.commonMetrics.TimingMetricTask
    config:
      connections.labelName: imageDifferenceNoFakes
      target: imageDifferenceNoFakes:astrometer.loadAndMatch
  timing_imageDifference_register:
    class: lsst.verify.tasks.commonMetrics.TimingMetricTask
    config:
      connections.labelName: imageDifferenceNoFakes
      target: imageDifferenceNoFakes:register.run
  timing_imageDifference_subtract:
    class: lsst.verify.tasks.commonMetrics.TimingMetricTask
    config:
      connections.labelName: imageDifferenceNoFakes
      target: imageDifferenceNoFakes:subtract.subtractExposures
  timing_imageDifference_detection:
    class: lsst.verify.tasks.commonMetrics.TimingMetricTask
    config:
      connections.labelName: imageDifferenceNoFakes
      target: imageDifferenceNoFakes:detection.run
  timing_imageDifference_measurement:
    class: lsst.verify.tasks.commonMetrics.TimingMetricTask
    config:
      connections.labelName: imageDifferenceNoFakes
      target: imageDifferenceNoFakes:measurement.run
  timing_transformDiaSrcCat:
    class: lsst.verify.tasks.commonMetrics.TimingMetricTask
    config:
      connections.labelName: transformDiaSrcCatWithFakes
      target: transformDiaSrcCatWithFakes.run
subsets:
  apPipe:
    subset:
      - isr
      - characterizeImage
      - calibrate
      - retrieveTemplate
      - imageDifferenceNoFakes
    description: >
      The AP pipeline without fakes. Only includes processing through
      image differencing.
  prepareFakes:
    subset:
      - createFakes
      - coaddFakes
    description: >
      Creation of fake sources.
  apPipeWithFakes:
    subset:
      - processVisitFakes    # characterizeImage and calibrate with fakes
      - retrieveTemplateWithFakes
      - imageDifferenceWithFakes
      - transformDiaSrcCatWithFakes
      - diaPipe
      - fakesMatch
    description: >
      The AP pipeline with fakes. Requires apPipe and prepareFakes subsets.
contracts:
  # Metric inputs must match pipeline outputs
  # Use of ConnectionsClass for templated fields is a workaround for DM-30210
  - createFakes.connections.ConnectionsClass(config=createFakes).fakeCat.name ==
      coaddFakes.connections.ConnectionsClass(config=coaddFakes).fakeCat.name
  - createFakes.connections.ConnectionsClass(config=createFakes).fakeCat.name ==
      processVisitFakes.connections.ConnectionsClass(config=processVisitFakes).fakeCats.name
  - coaddFakes.connections.ConnectionsClass(config=coaddFakes).imageWithFakes.name ==
      retrieveTemplateWithFakes.connections.ConnectionsClass(config=retrieveTemplateWithFakes).coaddExposures.name
  - processVisitFakes.connections.ConnectionsClass(config=processVisitFakes).outputExposure.name ==
      imageDifferenceWithFakes.connections.ConnectionsClass(config=imageDifferenceWithFakes).exposure.name
  - createFakes.connections.ConnectionsClass(config=createFakes).fakeCat.name ==
      fakesMatch.connections.ConnectionsClass(config=fakesMatch).fakeCats.name
  - imageDifferenceWithFakes.connections.ConnectionsClass(config=imageDifferenceWithFakes).subtractedExposure.name ==
      fakesMatch.connections.ConnectionsClass(config=fakesMatch).diffIm.name
  - diaPipe.connections.ConnectionsClass(config=diaPipe).associatedDiaSources.name ==
      fakesMatch.connections.ConnectionsClass(config=fakesMatch).associatedDiaSources.name
  - retrieveTemplateWithFakes.connections.ConnectionsClass(config=retrieveTemplateWithFakes).outputExposure.name ==
      imageDifferenceWithFakes.connections.ConnectionsClass(config=imageDifferenceWithFakes).inputTemplate.name
  - fakesMatch.connections.ConnectionsClass(config=fakesMatch).matchedDiaSources.name ==
      apFakesCompletenessMag20t22.connections.ConnectionsClass(config=apFakesCompletenessMag20t22).matchedFakes.name
  - fakesMatch.connections.ConnectionsClass(config=fakesMatch).matchedDiaSources.name ==
      apFakesCompletenessMag22t24.connections.ConnectionsClass(config=apFakesCompletenessMag22t24).matchedFakes.name
  - fakesMatch.connections.ConnectionsClass(config=fakesMatch).matchedDiaSources.name ==
      apFakesCompletenessMag24t26.connections.ConnectionsClass(config=apFakesCompletenessMag24t26).matchedFakes.name
  - imageDifferenceNoFakes.connections.ConnectionsClass(config=imageDifferenceNoFakes).diaSources.name ==
      fracDiaSourcesToSciSources.connections.ConnectionsClass(config=fracDiaSourcesToSciSources).diaSources.name
